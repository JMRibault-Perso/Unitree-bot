<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G1 Robot Controller - Professional UI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --bg-dark: #0f1419;
            --bg-panel: #1a1f2e;
            --text-light: #e0e0e0;
            --text-muted: #718096;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-light);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 280px 1fr 350px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 0;
        }

        /* TOP BAR */
        .top-bar {
            grid-column: 1 / -1;
            background: var(--bg-panel);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            gap: 20px;
        }

        .robot-info {
            display: flex;
            gap: 30px;
            flex: 1;
            align-items: center;
        }

        .robot-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 4px 12px;
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid var(--success);
            border-radius: 4px;
            color: var(--success);
        }

        .status-badge.offline {
            background: rgba(245, 101, 101, 0.1);
            border-color: var(--danger);
            color: var(--danger);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-badge.offline .status-dot {
            background: var(--danger);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .telemetry-badges {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 11px;
            gap: 2px;
        }

        .badge-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
        }

        .badge-label {
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .connect-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
        }

        .connect-btn:active {
            transform: translateY(0);
        }

        /* LEFT SIDEBAR */
        .left-sidebar {
            background: var(--bg-panel);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-section {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .nav-section:last-child {
            border-bottom: none;
        }

        .nav-button {
            width: 100%;
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-button:hover {
            color: var(--text-light);
            background: rgba(102, 126, 234, 0.1);
            padding-left: 24px;
        }

        .nav-button.active {
            color: var(--primary);
            background: rgba(102, 126, 234, 0.2);
            border-left: 3px solid var(--primary);
            padding-left: 17px;
        }

        /* CENTER AREA */
        .center-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            overflow: hidden;
        }

        .video-container {
            flex: 0 0 45%;
            background: #000;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .map-container {
            flex: 1;
            background: var(--bg-panel);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        #mapCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* RIGHT SIDEBAR */
        .right-sidebar {
            background: var(--bg-panel);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow-y: auto;
            gap: 15px;
        }

        .panel {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 12px;
        }

        .panel-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: block;
        }

        /* FSM STATE DISPLAY */
        .fsm-state-display {
            text-align: center;
            padding: 12px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid var(--primary);
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .fsm-state-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
        }

        .fsm-state-value {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* FSM BUTTONS */
        .fsm-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .state-btn {
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .state-btn:hover:not(:disabled) {
            color: var(--text-light);
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .state-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-color: var(--primary);
        }

        .state-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* MOVEMENT CONTROLS */
        .movement-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: auto;
        }

        .speed-control {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .speed-label {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .speed-value {
            color: var(--primary);
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.6);
        }

        /* MOVEMENT GRID */
        .movement-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .move-btn {
            padding: 12px;
            background: rgba(102, 126, 234, 0.15);
            border: 2px solid rgba(102, 126, 234, 0.3);
            color: var(--text-light);
            border-radius: 6px;
            cursor: pointer;
            font-size: 20px;
            font-weight: 700;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1;
            min-height: 50px;
        }

        .move-btn:hover {
            color: white;
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.3);
            transform: scale(1.08);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.4);
        }

        .move-btn:active {
            background: var(--primary);
            color: white;
            border-color: var(--primary-dark);
            transform: scale(0.95);
        }

        .move-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .move-btn.stop-btn {
            background: rgba(245, 101, 101, 0.15);
            border-color: rgba(245, 101, 101, 0.3);
        }

        .move-btn.stop-btn:hover {
            border-color: #f56565;
            background: rgba(245, 101, 101, 0.3);
        }

        .move-btn.rotate-btn {
            grid-column: span 5;
            padding: 12px 16px;
            aspect-ratio: auto;
            min-height: 45px;
            font-size: 16px;
        }

        /* CONTENT VIEWS */
        .content-view {
            display: none;
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .content-view.active {
            display: block;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-panel);
            border-radius: 8px;
            padding: 40px;
            max-width: 550px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            border: 2px solid var(--primary);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            color: var(--primary);
            text-align: center;
        }

        .form-group {
            margin-bottom: 22px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-light);
        }

        .form-input {
            padding: 14px 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--text-light);
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
            font-size: 15px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.15);
            box-shadow: 0 0 12px rgba(102, 126, 234, 0.3);
        }

        .form-input:disabled {
            background: rgba(255, 255, 255, 0.03);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
        }

        .select-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        select.form-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23e0e0e0' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
            cursor: pointer;
        }

        select.form-input option {
            background: var(--bg-dark);
            color: var(--text-light);
            padding: 10px;
        }

        select.form-input option:checked {
            background: var(--primary);
            color: white;
        }

        .form-buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .form-buttons button {
            flex: 1;
            padding: 14px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-light);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* GESTURE BUTTONS */
        .gesture-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .gesture-btn {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .gesture-btn:hover:not(:disabled) {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .gesture-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .gesture-emoji {
            font-size: 24px;
            display: block;
            margin-bottom: 6px;
        }

        .gesture-name {
            font-size: 12px;
            font-weight: 600;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- TOP BAR -->
        <div class="top-bar">
            <div class="robot-info">
                <div class="robot-name" id="robotName">G1 Robot</div>
                <div class="status-badge offline" id="statusBadge">
                    <span class="status-dot"></span>
                    <span id="statusText">Offline</span>
                </div>
            </div>
            <div class="telemetry-badges">
                <div class="badge">
                    <div class="badge-label">Battery</div>
                    <div class="badge-value" id="batteryValue">--%</div>
                </div>
                <div class="badge">
                    <div class="badge-label">Voltage</div>
                    <div class="badge-value" id="voltageValue">--V</div>
                </div>
                <div class="badge">
                    <div class="badge-label">Temp</div>
                    <div class="badge-value" id="tempValue">--¬∞C</div>
                </div>
            </div>
            <button class="connect-btn" id="connectBtn" onclick="openConnectionModal()">Connect</button>
        </div>

        <!-- LEFT SIDEBAR -->
        <div class="left-sidebar">
            <div class="nav-section">
                <button class="nav-button active" onclick="switchView('gestures')">üëã Gestures</button>
                <button class="nav-button" onclick="switchView('slam')">üó∫Ô∏è SLAM</button>
            </div>
            <div class="nav-section">
                <button class="nav-button" onclick="switchView('actions')">üé¨ Custom Actions</button>
                <button class="nav-button" onclick="switchView('status')">üìä Status</button>
            </div>
        </div>

        <!-- CENTER AREA -->
        <div class="center-area">
            <div class="video-container">
                <img id="videoStream" src="" alt="Video Stream" style="display:none;">
                <div id="videoPlaceholder" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted);">
                    No video stream
                </div>
            </div>
            <div class="map-container">
                <canvas id="mapCanvas"></canvas>
            </div>
        </div>

        <!-- RIGHT SIDEBAR -->
        <div class="right-sidebar">
            <!-- FSM STATE -->
            <div class="panel">
                <span class="panel-title">FSM State</span>
                <div class="fsm-state-display">
                    <div class="fsm-state-name" id="currentStateDisplay">ZERO_TORQUE</div>
                    <div class="fsm-state-value" id="currentStateValue">(ID: 0)</div>
                </div>
                <div class="fsm-buttons" id="fsmButtons"></div>
            </div>

            <!-- MOVEMENT CONTROLS -->
            <div class="panel movement-panel">
                <span class="panel-title">Movement</span>
                <div class="speed-control">
                    <div class="speed-label">
                        <span>Speed</span>
                        <span class="speed-value" id="speedValue">1.0x</span>
                    </div>
                    <input type="range" min="0.1" max="3.0" step="0.1" value="1.0" id="speedSlider" onchange="updateSpeed()">
                </div>
                <div class="movement-grid">
                    <!-- Row 1: Empty, Forward, Empty -->
                    <div></div>
                    <button class="move-btn" onclick="sendMovement(0.3, 0)" title="Forward (W)">‚¨ÜÔ∏è</button>
                    <div></div>
                    <button class="move-btn" onclick="sendMovement(0, 0.5)" title="Rotate Left (Q)">‚Ü∂</button>
                    <div></div>
                    
                    <!-- Row 2: Left, Stop, Right -->
                    <button class="move-btn" onclick="sendMovement(0, 0.6)" title="Left (A)">‚¨ÖÔ∏è</button>
                    <button class="move-btn stop-btn" onclick="sendMovement(0, 0)" title="Stop (Space)">‚èπÔ∏è</button>
                    <button class="move-btn" onclick="sendMovement(0, -0.6)" title="Right (D)">‚û°Ô∏è</button>
                    <div></div>
                    <div></div>
                    
                    <!-- Row 3: Empty, Backward, Empty -->
                    <div></div>
                    <button class="move-btn" onclick="sendMovement(-0.3, 0)" title="Backward (S)">‚¨áÔ∏è</button>
                    <div></div>
                    <button class="move-btn" onclick="sendMovement(0, -0.5)" title="Rotate Right (E)">‚Ü∑</button>
                    <div></div>
                    
                    <!-- Rotation buttons -->
                    <button class="move-btn rotate-btn" style="grid-column: 1 / -1; grid-row: 5;" onclick="sendMovement(0, -0.5)" title="Rotate Right (E)">‚Ü∑ Rotate Right</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-top: 8px; font-size: 10px;">
                    <div style="color: var(--text-muted);">vx: <span id="velX" style="color: var(--primary);">0</span></div>
                    <div style="color: var(--text-muted);">vy: <span id="velY" style="color: var(--primary);">0</span></div>
                    <div style="color: var(--text-muted);">œâ: <span id="velOmega" style="color: var(--primary);">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENT VIEWS -->
    <div id="movement-view" class="content-view active">
        <h2 style="margin-bottom: 20px;">Movement Control</h2>
        <p>Use WASD keys or click buttons to control movement.</p>
        <p style="color: var(--text-muted); font-size: 12px; margin-top: 10px;">
            <strong>W</strong> - Forward | <strong>A</strong> - Left | <strong>S</strong> - Backward | <strong>D</strong> - Right | <strong>Q</strong> - Rotate Left | <strong>E</strong> - Rotate Right | <strong>Space</strong> - Stop
        </p>
    </div>

    <div id="gestures-view" class="content-view">
        <h2 style="margin-bottom: 20px;">Gestures</h2>
        <div class="gesture-grid" id="gestureGrid"></div>
    </div>

    <div id="slam-view" class="content-view">
        <h2 style="margin-bottom: 20px;">SLAM Mapping</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn-primary" onclick="startMapping()">‚ñ∂Ô∏è Start Mapping</button>
            <button class="btn-secondary" onclick="stopMapping()">‚èπÔ∏è Stop Mapping</button>
        </div>
        <p style="color: var(--text-muted); font-size: 12px;">Point cloud displays in real-time. Odometry data only available during active mapping.</p>
    </div>

    <div id="actions-view" class="content-view">
        <h2 style="margin-bottom: 20px;">Custom Actions</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <input type="text" id="actionName" class="form-input" placeholder="Action name" style="flex: 1;">
            <button class="btn-primary" onclick="addCustomAction()">+ Add</button>
        </div>
        <div id="actionsList" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;"></div>
    </div>

    <div id="status-view" class="content-view">
        <h2 style="margin-bottom: 20px;">Robot Status</h2>
        <div style="display: grid; gap: 15px;">
            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">FSM State</div>
                <div style="font-size: 16px; font-weight: 600; color: var(--primary); margin-top: 4px;" id="statusFsmId">0</div>
            </div>
            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">FSM Mode</div>
                <div style="font-size: 16px; font-weight: 600; color: var(--primary); margin-top: 4px;" id="statusFsmMode">0</div>
            </div>
            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Battery Voltage</div>
                <div style="font-size: 16px; font-weight: 600; color: var(--primary); margin-top: 4px;" id="statusVoltage">-- V</div>
            </div>
            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Temperature</div>
                <div style="font-size: 16px; font-weight: 600; color: var(--primary); margin-top: 4px;" id="statusTemp">-- ¬∞C</div>
            </div>
        </div>
    </div>

    <!-- CONNECTION MODAL -->
    <div id="connectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Connect to Robot</div>
            
            <div class="form-group">
                <label class="form-label">Select Robot</label>
                <select id="robotSelect" class="form-input" onchange="selectRobot()">
                    <option value="">-- Choose a robot --</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Or Add New Robot</label>
                <div class="select-group">
                    <input type="text" id="newRobotNickname" class="form-input" placeholder="Nickname (e.g., G1_1)">
                    <input type="text" id="newRobotMac" class="form-input" placeholder="MAC Address">
                </div>
                <input type="text" id="newRobotSerial" class="form-input" placeholder="Serial Number">
                <button class="btn-secondary" style="width: 100%; margin-top: 8px;" onclick="addRobot()">+ Add Robot</button>
            </div>

            <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">

            <div class="form-group">
                <label class="form-label">Robot IP</label>
                <input type="text" id="robotIp" class="form-input" placeholder="IP Address" readonly>
            </div>

            <div class="form-group">
                <label class="form-label">Serial Number</label>
                <input type="text" id="robotSerial" class="form-input" placeholder="Serial Number" readonly>
            </div>

            <div class="form-buttons">
                <button class="btn-primary" onclick="connectRobot()">Connect</button>
                <button class="btn-secondary" onclick="closeConnectionModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const G1_MAC = "fc:23:cd:92:60:02";
        const G1_SERIAL = "E21D1000PAHBMB06";
        const G1_NICKNAME = "G1_6937";
        
        let velocityScale = 1.0;
        let wsConnection = null;
        let currentRobot = null;
        let videoStreamInterval = null;
        let pointCloudInterval = null;
        // Pre-populate with your robot data
        let allRobots = [
            { nickname: "G1_6937", mac: "fc:23:cd:92:60:02", serial_number: "E21D1000PAHBMB06", ip: "192.168.86.2" }
        ];
        let connectedRobotMac = null;

        // State variables
        const FSM_STATES = {
            0: { name: "ZERO_TORQUE", label: "Motors Off" },
            1: { name: "DAMP", label: "Safe Mode" },
            2: { name: "SQUAT", label: "Squat" },
            3: { name: "SIT", label: "Sitting" },
            4: { name: "LOCK_STANDING", label: "Stand Up" },
            200: { name: "START", label: "Ready" },
            500: { name: "LOCK_STAND", label: "Walk Mode" },
            702: { name: "STAND_UP", label: "Rise" },
            706: { name: "SQUAT_TO_STAND", label: "Toggle Squat" },
            801: { name: "RUN", label: "Run Mode" }
        };

        const STATE_TRANSITIONS = {
            0: [1],
            1: [0, 200, 3, 706],
            3: [1, 707],
            200: [1, 500, 706, 801],
            500: [1, 200],
            706: [500],
            801: [1, 200],
            707: [1],
            702: [200],
            2: [1],
            4: [1]
        };

        const GESTURES = [
            { emoji: "üëã", name: "Wave" },
            { emoji: "ü§ù", name: "Shake Hand" },
            { emoji: "üëè", name: "Clap" },
            { emoji: "üíã", name: "Kiss" },
            { emoji: "üôå", name: "Hands Up" },
            { emoji: "‚ù§Ô∏è", name: "Heart" },
            { emoji: "ü§ó", name: "Hug" },
            { emoji: "‚úã", name: "High Five" },
            { emoji: "üëç", name: "Thumbs Up" },
            { emoji: "üëé", name: "Thumbs Down" }
        ];

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            loadRobots();
            initializeGestures();
            setupKeyboardControls();
            connectWebSocket();
            initializePointCloudViewer();
            updateFsmButtons(0, [1]);
            updateConnectionStatus(false);
            stopVideoStream();
            stopPointCloudPolling();

            window.addEventListener('beforeunload', () => {
                if (connectedRobotMac && navigator.sendBeacon) {
                    navigator.sendBeacon('/api/disconnect');
                }
            });
        });

        // Robot Management
        async function loadRobots() {
            try {
                const response = await fetch('/api/robots');
                allRobots = await response.json();
                populateRobotDropdown();
                localStorage.setItem('storedRobots', JSON.stringify(allRobots));
            } catch (e) {
                console.warn('Could not load robot list from API, using defaults + local storage');
                const stored = localStorage.getItem('storedRobots');
                if (stored) {
                    allRobots = JSON.parse(stored);
                } else {
                    // Ensure default robot is always available
                    allRobots = [
                        { nickname: "G1_6937", mac: "fc:23:cd:92:60:02", serial_number: "E21D1000PAHBMB06", ip: "192.168.86.2" }
                    ];
                    localStorage.setItem('storedRobots', JSON.stringify(allRobots));
                }
                populateRobotDropdown();
            }
        }

        function populateRobotDropdown() {
            const select = document.getElementById('robotSelect');
            select.innerHTML = '<option value="">-- Choose a robot --</option>';
            allRobots.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.mac;
                opt.textContent = `${r.nickname} (${r.mac})`;
                select.appendChild(opt);
            });
        }

        function selectRobot() {
            const mac = document.getElementById('robotSelect').value;
            const robot = allRobots.find(r => r.mac === mac);
            if (robot) {
                document.getElementById('robotIp').value = robot.ip || 'Auto-discover';
                document.getElementById('robotSerial').value = robot.serial_number || '';
            }
        }

        function addRobot() {
            const nickname = document.getElementById('newRobotNickname').value;
            const mac = document.getElementById('newRobotMac').value;
            const serial = document.getElementById('newRobotSerial').value;

            if (!nickname || !mac || !serial) {
                alert('Please fill in all fields');
                return;
            }

            fetch('/api/add_robot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nickname, mac, serial_number: serial })
            }).then(() => {
                loadRobots();
                document.getElementById('newRobotNickname').value = '';
                document.getElementById('newRobotMac').value = '';
                document.getElementById('newRobotSerial').value = '';
            }).catch(() => {
                const newRobot = { nickname, mac, serial_number: serial, ip: '' };
                if (!allRobots) allRobots = [];
                allRobots.push(newRobot);
                localStorage.setItem('storedRobots', JSON.stringify(allRobots));
                populateRobotDropdown();
                document.getElementById('newRobotNickname').value = '';
                document.getElementById('newRobotMac').value = '';
                document.getElementById('newRobotSerial').value = '';
                alert('Robot added successfully!');
            });
        }

        // Connection
        async function connectRobot() {
            const robotSelect = document.getElementById('robotSelect').value || G1_MAC;
            const ip = document.getElementById('robotIp').value;
            const robot = allRobots.find(r => r.mac === robotSelect) || {
                mac: robotSelect,
                serial_number: G1_SERIAL,
                nickname: 'G1'
            };

            if (!robot.serial_number) {
                alert('Serial number is required to connect. Please add/select a robot with a serial number.');
                return;
            }

            try {
                const response = await fetch(`/api/connect?ip=${ip}&mac=${robot.mac}&serial_number=${robot.serial_number}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    connectedRobotMac = robot.mac;
                    currentRobot = robot;
                    document.getElementById('robotName').textContent = robot.nickname || 'G1 Robot';
                    closeConnectionModal();
                    updateConnectionStatus(true);
                    startVideoStream();
                    startPointCloudPolling();
                } else {
                    alert('Connection failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Connection error: ' + e.message);
            }
        }

        function openConnectionModal() {
            document.getElementById('connectionModal').classList.add('active');
        }

        function closeConnectionModal() {
            document.getElementById('connectionModal').classList.remove('active');
        }

        async function disconnectRobot() {
            try {
                await fetch('/api/disconnect', { method: 'POST' });
            } catch (e) {
                console.warn('Disconnect request failed:', e);
            } finally {
                connectedRobotMac = null;
                currentRobot = null;
                updateConnectionStatus(false);
            }
        }

        // WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            wsConnection = new WebSocket(`${protocol}//${window.location.host}/ws`);

            wsConnection.onopen = () => console.log('WebSocket connected');
            wsConnection.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            wsConnection.onerror = (e) => console.error('WebSocket error:', e);
            wsConnection.onclose = () => {
                setTimeout(connectWebSocket, 2000);
            };
        }

        function handleWebSocketMessage(data) {
            if (data.type === 'state_changed') {
                const state = data.data;
                if (state) {
                    updateFsmDisplay(state.fsm_id, state.fsm_mode);
                    updateStatus(state);
                }
            } else if (data.type === 'connection_changed') {
                const connected = !!data.data?.connected;
                if (!connected) {
                    connectedRobotMac = null;
                    currentRobot = null;
                }
                updateConnectionStatus(connected);
            } else if (data.type === 'battery_updated') {
                updateBattery(data.data);
            } else if (data.type === 'lidar_cloud') {
                updatePointCloud(data.data);
            }
        }

        function updateConnectionStatus(connected) {
            const badge = document.getElementById('statusBadge');
            const text = document.getElementById('statusText');
            const connectBtn = document.getElementById('connectBtn');
            if (connected) {
                badge.classList.remove('offline');
                text.textContent = 'Online';
                if (connectBtn) {
                    connectBtn.textContent = 'Disconnect';
                    connectBtn.onclick = disconnectRobot;
                }
            } else {
                badge.classList.add('offline');
                text.textContent = 'Offline';
                stopVideoStream();
                stopPointCloudPolling();
                if (connectBtn) {
                    connectBtn.textContent = 'Connect';
                    connectBtn.onclick = openConnectionModal;
                }
            }
        }

        // FSM State Management
        function updateFsmDisplay(stateId, mode) {
            const state = FSM_STATES[stateId] || FSM_STATES[0];
            document.getElementById('currentStateDisplay').textContent = state.name;
            document.getElementById('currentStateValue').textContent = `(ID: ${stateId}, Mode: ${mode})`;
            document.getElementById('statusFsmId').textContent = stateId;
            document.getElementById('statusFsmMode').textContent = mode;
            
            const transitions = STATE_TRANSITIONS[stateId] || [];
            updateFsmButtons(stateId, transitions);
        }

        function updateFsmButtons(currentState, allowedTransitions) {
            const container = document.getElementById('fsmButtons');
            container.innerHTML = '';

            Object.entries(FSM_STATES).forEach(([id, state]) => {
                const btn = document.createElement('button');
                btn.className = 'state-btn';
                btn.textContent = state.label;
                btn.dataset.state = id;

                if (parseInt(id) === currentState) {
                    btn.classList.add('active');
                } else if (allowedTransitions.includes(parseInt(id))) {
                    btn.onclick = () => setFsmState(parseInt(id));
                } else {
                    btn.disabled = true;
                }

                container.appendChild(btn);
            });
        }

        async function setFsmState(stateId) {
            try {
                const response = await fetch(`/api/set_state?state_name=${FSM_STATES[stateId].name}`);
                const data = await response.json();
                if (!data.success) {
                    console.error('Failed to set state:', data.message);
                }
            } catch (e) {
                console.error('State change error:', e);
            }
        }

        // Movement
        function updateSpeed() {
            velocityScale = parseFloat(document.getElementById('speedSlider').value);
            document.getElementById('speedValue').textContent = `${velocityScale.toFixed(1)}x`;
        }

        async function sendMovement(vx, vy, omega = 0) {
            const scaled_vx = vx * velocityScale;
            const scaled_vy = vy * velocityScale;
            const scaled_omega = omega * velocityScale;

            document.getElementById('velX').textContent = scaled_vx.toFixed(2);
            document.getElementById('velY').textContent = scaled_vy.toFixed(2);
            document.getElementById('velOmega').textContent = scaled_omega.toFixed(2);

            try {
                await fetch('/api/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vx: scaled_vx,
                        vy: scaled_vy,
                        omega: scaled_omega
                    })
                });
            } catch (e) {
                console.error('Move error:', e);
            }
        }

        // Keyboard Controls
        function setupKeyboardControls() {
            const keysPressed = {};

            window.addEventListener('keydown', (e) => {
                keysPressed[e.key.toLowerCase()] = true;
                processKeyboardMovement(keysPressed);
            });

            window.addEventListener('keyup', (e) => {
                keysPressed[e.key.toLowerCase()] = false;
                processKeyboardMovement(keysPressed);
            });
        }

        function processKeyboardMovement(keys) {
            let vx = 0, vy = 0, omega = 0;

            if (keys['w']) vx += 0.3;
            if (keys['s']) vx -= 0.3;
            if (keys['a']) vy += 0.6;
            if (keys['d']) vy -= 0.6;
            if (keys['q']) omega += 0.5;
            if (keys['e']) omega -= 0.5;
            if (keys[' ']) { vx = vy = omega = 0; }

            if (vx !== 0 || vy !== 0 || omega !== 0) {
                sendMovement(vx, vy, omega);
            }
        }

        // Gestures
        function initializeGestures() {
            const grid = document.getElementById('gestureGrid');
            GESTURES.forEach(g => {
                const btn = document.createElement('button');
                btn.className = 'gesture-btn';
                btn.innerHTML = `<span class="gesture-emoji">${g.emoji}</span><span class="gesture-name">${g.name}</span>`;
                btn.onclick = () => executeGesture(g.name);
                grid.appendChild(btn);
            });
        }

        async function executeGesture(name) {
            try {
                const response = await fetch(`/api/custom_action/execute?action_name=${name}`);
                const data = await response.json();
                if (!data.success) {
                    console.error('Gesture failed:', data.message);
                }
            } catch (e) {
                console.error('Gesture error:', e);
            }
        }

        // Custom Actions
        async function addCustomAction() {
            const name = document.getElementById('actionName').value;
            if (!name) return;

            try {
                const response = await fetch(`/api/custom_action/add?action_name=${name}`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('actionName').value = '';
                    loadCustomActions();
                }
            } catch (e) {
                console.error('Add action error:', e);
            }
        }

        async function loadCustomActions() {
            try {
                const response = await fetch('/api/custom_action/robot_list');
                const data = await response.json();
                const list = document.getElementById('actionsList');
                list.innerHTML = '';

                if (data.actions) {
                    data.actions.forEach(action => {
                        const btn = document.createElement('button');
                        btn.className = 'gesture-btn';
                        btn.textContent = action;
                        btn.onclick = () => executeGesture(action);
                        list.appendChild(btn);
                    });
                }
            } catch (e) {
                console.error('Load actions error:', e);
            }
        }

        // SLAM
        async function startMapping() {
            try {
                const response = await fetch('/api/slam/start', { method: 'POST' });
                console.log('Mapping started');
            } catch (e) {
                console.error('Start mapping error:', e);
            }
        }

        async function stopMapping() {
            try {
                const response = await fetch('/api/slam/stop', { method: 'POST' });
                console.log('Mapping stopped');
            } catch (e) {
                console.error('Stop mapping error:', e);
            }
        }

        // Telemetry
        function updateBattery(data) {
            if (data.soc !== undefined) {
                document.getElementById('batteryValue').textContent = data.soc + '%';
            }
            if (data.bmsvoltage !== undefined) {
                document.getElementById('voltageValue').textContent = (data.bmsvoltage / 1000).toFixed(1) + 'V';
                document.getElementById('statusVoltage').textContent = (data.bmsvoltage / 1000).toFixed(1) + ' V';
            }
            if (data.temperature !== undefined) {
                document.getElementById('tempValue').textContent = data.temperature + '¬∞C';
                document.getElementById('statusTemp').textContent = data.temperature + ' ¬∞C';
            }
        }

        function updateStatus(state) {
            if (state.fsm_id !== undefined) {
                updateFsmDisplay(state.fsm_id, state.fsm_mode || 0);
            }
        }

        // Video Stream
        function startVideoStream() {
            if (!connectedRobotMac || videoStreamInterval) {
                return;
            }
            const img = document.getElementById('videoStream');
            const placeholder = document.getElementById('videoPlaceholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            img.style.display = 'block';

            videoStreamInterval = setInterval(() => {
                if (!connectedRobotMac) {
                    stopVideoStream();
                    return;
                }
                img.src = `/api/video/stream?t=${Date.now()}`;
            }, 100);
        }

        function stopVideoStream() {
            if (videoStreamInterval) {
                clearInterval(videoStreamInterval);
                videoStreamInterval = null;
            }
            const img = document.getElementById('videoStream');
            const placeholder = document.getElementById('videoPlaceholder');
            if (img) {
                img.src = '';
                img.style.display = 'none';
            }
            if (placeholder) {
                placeholder.style.display = 'flex';
            }
        }

        // Point Cloud Viewer
        let scene, camera, renderer, pointCloudMesh;

        function initializePointCloudViewer() {
            const canvas = document.getElementById('mapCanvas');
            if (!canvas) return;
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f1419);

            camera = new THREE.PerspectiveCamera(
                75,
                canvas.clientWidth / canvas.clientHeight,
                0.1,
                1000
            );
            camera.position.set(0, 2, 3);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            // Grid
            const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
            scene.add(gridHelper);

            // Axes
            const axesHelper = new THREE.AxesHelper(2);
            scene.add(axesHelper);

            // Lighting
            const light = new THREE.PointLight(0xffffff, 1);
            light.position.set(10, 10, 10);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x808080));

            // Point cloud placeholder
            const geometry = new THREE.BufferGeometry();
            const material = new THREE.PointsMaterial({ size: 0.02, sizeAttenuation: true });
            pointCloudMesh = new THREE.Points(geometry, material);
            scene.add(pointCloudMesh);

            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();

            // Handle window resize
            window.addEventListener('resize', () => {
                const width = canvas.clientWidth;
                const height = canvas.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            });

            // Start polling only after connection
            // (startPointCloudPolling is called after connect)
        }

        function startPointCloudPolling() {
            if (pointCloudInterval) {
                return;
            }
            pointCloudInterval = setInterval(updatePointCloud, 100);
        }

        function stopPointCloudPolling() {
            if (pointCloudInterval) {
                clearInterval(pointCloudInterval);
                pointCloudInterval = null;
            }
            if (pointCloudMesh) {
                pointCloudMesh.geometry.dispose();
                pointCloudMesh.geometry = new THREE.BufferGeometry();
            }
        }

        async function updatePointCloud() {
            if (!connectedRobotMac) {
                return;
            }
            try {
                const response = await fetch('/api/lidar/pointcloud');
                const data = await response.json();

                if (data.points && data.points.length > 0) {
                    const positions = new Float32Array(data.points.flat());
                    const colors = new Uint8Array(data.points.length * 3);

                    // Color by height
                    for (let i = 0; i < data.points.length; i++) {
                        const z = data.points[i][2] || 0;
                        const hue = Math.max(0, Math.min(1, (z + 2) / 4));
                        const rgb = hslToRgb(hue, 0.8, 0.5);
                        colors[i * 3] = rgb[0];
                        colors[i * 3 + 1] = rgb[1];
                        colors[i * 3 + 2] = rgb[2];
                    }

                    const geometry = new THREE.BufferGeometry();
                    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                    geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3, true));

                    const material = new THREE.PointsMaterial({
                        size: 0.02,
                        sizeAttenuation: true,
                        vertexColors: true
                    });

                    scene.remove(pointCloudMesh);
                    pointCloudMesh = new THREE.Points(geometry, material);
                    scene.add(pointCloudMesh);
                }
            } catch (e) {
                // Silently fail - no point cloud data yet
            }
        }

        function hslToRgb(h, s, l) {
            const c = (1 - Math.abs(2 * l - 1)) * s;
            const hp = h * 6;
            const x = c * (1 - Math.abs((hp % 2) - 1));
            let r, g, b;

            if (hp < 1) [r, g, b] = [c, x, 0];
            else if (hp < 2) [r, g, b] = [x, c, 0];
            else if (hp < 3) [r, g, b] = [0, c, x];
            else if (hp < 4) [r, g, b] = [0, x, c];
            else if (hp < 5) [r, g, b] = [x, 0, c];
            else [r, g, b] = [c, 0, x];

            const m = l - c / 2;
            return [
                Math.round((r + m) * 255),
                Math.round((g + m) * 255),
                Math.round((b + m) * 255)
            ];
        }

        // View Switching
        function switchView(view) {
            document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
            document.getElementById(view + '-view').classList.add('active');

            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (view === 'actions') {
                loadCustomActions();
            }
        }
    </script>
</body>
</html>
